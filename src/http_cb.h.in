#include <event2/buffer.h>
#include <event2/http.h>
#include <stdio.h> /* for printf */

static void
CALLBACK_NAME (struct evhttp_request *req, void *arg)
{
  time_t rawtime = time (0);

  struct evbuffer *buf = evbuffer_new ();
  evbuffer_add_printf (buf, "CALLBACK_CONTENT");
  evhttp_add_header (evhttp_request_get_output_headers (req), "Content-Type",
                     "MIME_TYPE");
  evhttp_send_reply (req, 200, "OK", buf);
  evbuffer_free (buf);

  struct tm *utc = gmtime (&rawtime);
  char timestamp[32];
  strftime (timestamp, 32, "%d/%b/%Y:%H:%M:%S %z", utc);

  char *client_ip;
  u_short client_port;

  evhttp_connection_get_peer (evhttp_request_get_connection (req), &client_ip,
                              &client_port);

  const struct evhttp_uri *uri_info = evhttp_request_get_evhttp_uri (req);

  // evhttp_request_get_input_headers

  // TODO separate access log?
  // TODO support user-identifier and userid?
  // TODO support retrieving method (instead of hardcoding it)
  // TODO protocol (e.g., HTTP/1.1) - not exposed by evhttp_uri?
  // TODO inject response size
  // TODO combined log format?
  // Common Log Format: https://en.wikipedia.org/wiki/Common_Log_Format
  printf ("access: %s - - [%s] \"GET %s\" 200 RESPONSE_SIZE\n", client_ip, timestamp,
          evhttp_request_get_uri (req));
}
